<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>3D People Tiles — Periodic Table Modified</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; overflow:hidden; background:#111; color:#fff; }
    #container { position: absolute; width: 100%; height: 100%; }
    .element {
      width: 160px; height: 190px;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      color: #fff;
      text-align: left;
      font-size: 12px;
      overflow: hidden;
    }
    .photo {
      width: 100%;
      height: 88px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.08);
    }
    .name { font-weight:700; font-size:14px; margin-bottom:4px; }
    .meta { font-size:11px; opacity:0.95; margin-bottom:2px; }
    .controls {
      position: absolute; left: 12px; top: 12px; z-index: 5;
      background: rgba(255,255,255,0.95); color:#000; padding: 10px; border-radius:8px;
      font-size:13px;
    }
    .controls button{ margin:4px; }
    .gsi-button-wrap { margin-bottom:8px; }
  </style>

  <!-- three.js + CSS3DRenderer -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/TrackballControls.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="container"></div>

  <div class="controls" id="controls" aria-live="polite">
    <div class="gsi-button-wrap">
      <div id="g_id_onload" 
           data-client_id="330173954188-eighpf5lec4lccknriqa5gkt19mjv98e.apps.googleusercontent.com"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-theme="outline" data-size="large" data-text="signin_with"></div>
    </div>

    <div>
      <button onclick="transformTo('table')">Table (20×10)</button>
      <button onclick="transformTo('sphere')">Sphere</button>
      <button onclick="transformTo('helix')">Double Helix</button>
      <button onclick="transformTo('grid')">Grid (5×4×10)</button>
      <button onclick="reloadData()">Reload Data</button>
    </div>

    <div style="margin-top:8px;">
      <strong>Signed in:</strong> <span id="userEmail">not signed in</span>
    </div>
  </div>

<script>
/* ----------------- CONFIG ----------------- */
const CLIENT_ID = '330173954188-eighpf5lec4lccknriqa5gkt19mjv98e.apps.googleusercontent.com';
const API_KEY = 'AIzaSyAt7SFLAOrKWIj2_-lyY_IpbBbWAc1Ie0Y';
const SPREADSHEET_ID = '13-qIqTXm0Ilp-PsWVcxUX9QpxHi_KfjgXCoKhqfQfAY';
const SHEET_RANGE = 'Sheet1!A1:F999';
const CSV_PUBLISHED_URL = ''; // (optional fallback)

/* ----------------- 3D / Scene Setup ----------------- */
let camera, scene, renderer, controls;
let objects = [];
let targets = { table: [], sphere: [], helix: [], grid: [] };
let itemsData = [];

init();
animate();

function init() {
  const container = document.getElementById('container');
  camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 10000);
  camera.position.z = 3000;

  scene = new THREE.Scene();

  renderer = new THREE.CSS3DRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.position = 'absolute';
  container.appendChild(renderer.domElement);

  controls = new THREE.TrackballControls(camera, renderer.domElement);
  controls.rotateSpeed = 0.5;
  controls.minDistance = 500;
  controls.maxDistance = 6000;

  window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  controls.handleResize();
}

function animate() {
  requestAnimationFrame(animate);
  TWEEN.update();
  controls.update();
  renderer.render(scene, camera);
}

/* ----------------- Tile creation ----------------- */
function createTile(row, idx) {
  const el = document.createElement('div');
  el.className = 'element';

  // Net Worth logic
  const net = parseNetWorth(row['Net Worth']);
  let bg = '#555';
  if (net < 100000) bg = '#c0392b';
  else if (net <= 200000) bg = '#d35400';
  else bg = '#27ae60';
  el.style.background = bg;

  const img = document.createElement('img');
  img.className = 'photo';
  img.src = row['Photo'] || 'https://via.placeholder.com/160x88?text=No+Photo';
  el.appendChild(img);

  el.innerHTML += `
    <div class="name">${row['Name']}</div>
    <div class="meta">Age: ${row['Age']}</div>
    <div class="meta">Country: ${row['Country']}</div>
    <div class="meta">Interest: ${row['Interest']}</div>
    <div class="meta">Net Worth: ${row['Net Worth']}</div>
  `;

  const objectCSS = new THREE.CSS3DObject(el);
  objectCSS.position.x = Math.random()*4000 - 2000;
  objectCSS.position.y = Math.random()*4000 - 2000;
  objectCSS.position.z = Math.random()*4000 - 2000;

  scene.add(objectCSS);
  objects.push(objectCSS);
}

function parseNetWorth(s) {
  if (!s) return 0;
  let n = String(s).replace(/[^0-9.]/g, '');
  return parseFloat(n) || 0;
}

/* ----------------- Layout targets ----------------- */
function buildTableTargets(count) {
  targets.table = [];
  const cols = 20, rows = 10;
  const spaceX = 180, spaceY = 210;
  const offX = (cols-1)*spaceX/2;
  const offY = (rows-1)*spaceY/2;

  for (let i=0;i<count;i++){
    const col = i % cols;
    const row = Math.floor(i / cols);
    const obj = new THREE.Object3D();
    obj.position.x = col*spaceX - offX;
    obj.position.y = -(row*spaceY - offY);
    targets.table.push(obj);
  }
}

function buildSphereTargets(count) {
  targets.sphere = [];
  const radius = 900;
  for (let i=0;i<count;i++){
    const phi = Math.acos(-1 + 2*i/count);
    const theta = Math.sqrt(count*Math.PI)*phi;
    const obj = new THREE.Object3D();
    obj.position.x = radius * Math.cos(theta)*Math.sin(phi);
    obj.position.y = radius * Math.sin(theta)*Math.sin(phi);
    obj.position.z = radius * Math.cos(phi);
    targets.sphere.push(obj);
  }
}

function buildDoubleHelixTargets(count) {
  targets.helix = [];
  const sep = 70, stepY = 24;
  const strandCount = Math.ceil(count/2);
  const totalHeight = strandCount*stepY;

  for (let i=0;i<count;i++){
    const strand = i % 2;
    const idx = Math.floor(i/2);
    const angle = idx*0.4 + (strand===0?0:Math.PI);

    const obj = new THREE.Object3D();
    obj.position.x = Math.cos(angle)*sep;
    obj.position.z = Math.sin(angle)*sep;
    obj.position.y = -(idx*stepY) + totalHeight/2;

    targets.helix.push(obj);
  }
}

function buildGridTargets(count) {
  targets.grid = [];
  const gx=5, gy=4, gz=10;
  const d=240;
  const ox=(gx-1)*d/2, oy=(gy-1)*d/2, oz=(gz-1)*d/2;

  for (let i=0;i<count;i++){
    const x=i%gx;
    const y=Math.floor(i/gx)%gy;
    const z=Math.floor(i/(gx*gy))%gz;

    const obj = new THREE.Object3D();
    obj.position.x = x*d - ox;
    obj.position.y = -(y*d - oy);
    obj.position.z = z*d - oz;

    targets.grid.push(obj);
  }
}

function transformTo(layout){
  const targetArr = targets[layout];
  if (!targetArr) return;

  objects.forEach((obj,i)=>{
    const target = targetArr[i];
    if (!target) return;

    new TWEEN.Tween(obj.position)
      .to({x:target.position.x,y:target.position.y,z:target.position.z},1300)
      .easing(TWEEN.Easing.Exponential.InOut).start();

    new TWEEN.Tween(obj.rotation)
      .to({x:0,y:0,z:0},1300)
      .easing(TWEEN.Easing.Exponential.InOut).start();
  });
}

/* ----------------- Data Loading ----------------- */
async function loadSheets(accessToken){
  const url =
`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}?majorDimension=ROWS`;

  const res = await fetch(url,{ headers:{ Authorization:`Bearer ${accessToken}` }});
  const json = await res.json();
  const rows = json.values;
  const headers = rows[0];

  return rows.slice(1).map(r=>{
    const obj={};
    headers.forEach((h,i)=> obj[h] = r[i] || '');
    return obj;
  });
}

async function loadData(token){
  const data = await loadSheets(token);

  objects.forEach(o=>scene.remove(o));
  objects = [];

  data.forEach((row,i)=> createTile(row,i));

  buildTableTargets(data.length);
  buildSphereTargets(data.length);
  buildDoubleHelixTargets(data.length);
  buildGridTargets(data.length);

  transformTo('table');
}

function reloadData(){
  if (window.gapiAccessToken) loadData(window.gapiAccessToken);
  else alert('Please sign in first.');
}

/* ----------------- Google Identity Services ----------------- */
function initializeGSI(){
  window.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email',
    callback: async (resp)=>{
      window.gapiAccessToken = resp.access_token;

      const info = await fetch('https://www.googleapis.com/oauth2/v3/userinfo',{
        headers:{ Authorization:`Bearer ${resp.access_token}` }
      }).then(r=>r.json());

      document.getElementById('userEmail').textContent = info.email;
      loadData(resp.access_token);
    }
  });

  document.querySelector('.g_id_signin')
    .addEventListener('click',()=> window.tokenClient.requestAccessToken({prompt:'consent'}));
}

window.addEventListener('load', initializeGSI);

/* ----------------- Minimal Tween ----------------- */
!function(global){var TWEEN={_tweens:[],getAll:function(){return TWEEN._tweens},removeAll:function(){TWEEN._tweens=[]},add:function(t){TWEEN._tweens.push(t)},remove:function(t){var i=TWEEN._tweens.indexOf(t);if(i!==-1)TWEEN._tweens.splice(i,1)},update:function(time){if(TWEEN._tweens.length===0)return false;time=time!==undefined?time:Date.now();var i=0;while(i<TWEEN._tweens.length){if(TWEEN._tweens[i].update(time))i++;else TWEEN._tweens.splice(i,1)}return true}};TWEEN.Tween=function(object){this.object=object;this.valuesStart={};this.valuesEnd={};this.duration=1000;this.easing=function(k){return k};this.startTime=null;for(var field in object)this.valuesStart[field]=parseFloat(object[field],10)||0};TWEEN.Tween.prototype.to=function(properties,duration){this.valuesEnd=properties;if(duration!==undefined)this.duration=duration;return this};TWEEN.Tween.prototype.start=function(time){TWEEN.add(this);this.startTime=time!==undefined?time:Date.now();for(var property in this.valuesEnd){if(this.object[property]===undefined)continue;this.valuesStart[property]=this.object[property];}return this};TWEEN.Tween.prototype.easing=function(fn){this.easing=fn;return this};TWEEN.Tween.prototype.update=function(time){if(time<this.startTime)return true;var elapsed=(time-this.startTime)/this.duration;elapsed=elapsed>1?1:elapsed;var value=this.easing(elapsed);for(var property in this.valuesEnd){var start=this.valuesStart[property]||0;var end=this.valuesEnd[property];this.object[property]=start+(end-start)*value;}if(elapsed==1){return false}return true};TWEEN.Easing={Exponential:{InOut:function(k){if((k*=2)<1)return 0.5*Math.pow(2,10*(k-1));return 0.5*(-Math.pow(2,-10*(k-1))+2)}}};global.TWEEN=TWEEN}(this);
</script>
</body>
</html>
